pipeline {
    agent {
      docker {
        label 'docker'
        image 'yuneecatl/px4-dev-simulation-python3:2019-03-18'
        args '-e HOME=$WORKSPACE -v /tmp/ccache:/tmp/ccache:rw'
      }
    }
    stages {
        stage('build') {
            steps {
                sh 'mkdir -p Tools/Maneuvers/build'
                sh 'pushd Tools/Maneuvers/build'
                sh 'cmake ../src'
                sh 'make'
                sh 'popd'
                sh 'pushd integrationtests/ulogtests/external/pyulgresample'
                sh 'FLIT_ROOT_INSTALL=1 flit install'
                sh 'popd'
                sh 'make distclean'
                sh 'make px4_sitl_default'
                sh 'make px4_sitl_default sitl_gazebo'
            }
            post {
              always {
                sh 'make distclean'
              }
            }
        } // stage build

        stage('integration tests') {
          steps {
            sh 'Tools/ulogtests/test_runner.sh. mission'
          }
        }
    }
}
