#!nsh
#
# @name Generic TAP-V4 config
#
# @type Quadrotor x
# @class Copter
#

sh /etc/init.d/rc.mc_defaults

if [ $AUTOCNF == yes -o $NEW_DEFAULTS == yes ]
then
	param set MAV_TYPE 2

	#
	# Control parameters setting for TAP-V4
	#

	# pitch angle & rate setting
	param set MC_PITCHRATE_P 0.1
	param set MC_PITCHRATE_I 0.1
	param set MC_PITCHRATE_D 0.0006
	param set MC_PITCHRATE_MAX 360.0
	param set MC_PITCH_P 8.0

	# roll angle & rate setting
	param set MC_ROLLRATE_P 0.1
	param set MC_ROLLRATE_I 0.1
	param set MC_ROLLRATE_D 0.0006
	param set MC_ROLLRATE_MAX 360.0
	param set MC_ROLL_P 8.0

	# yaw angle & rate setting
	param set MC_YAWRATE_P 0.15
	param set MC_YAWRATE_I 0.1
	param set MC_YAWRATE_MAX 100.0
	param set MC_YAWRAUTO_MAX 80.0
	param set MC_YAW_P 2.8

	# filtering
	param set MC_DTERM_CUTOFF 100
	param set IMU_GYRO_CUTOFF 150

	# hover thrust
	param set MPC_THR_HOVER 0.525

	# Position control parameters
	param set MPC_XY_P 2.0
	param set MPC_XY_VEL_P 0.4
	param set MPC_XY_VEL_D 0.005
	param set MPC_XY_VEL_I 0.08
	param set MPC_Z_VEL_P 0.55
	param set MPC_Z_P 3.0
	param set MPC_Z_VEL_D 0.0
	param set MPC_Z_VEL_I 0.1

	# Manual stick input parameters
	param set RC_FLT_SMP_RATE 33.0
	param set RC_FLT_CUTOFF 5.0
	param set MPC_HOLD_XY_DZ 0.05
	param set MPC_XY_MAN_EXPO 0.7
	param set MPC_Z_MAN_EXPO 0.6
	param set MPC_MANTHR_MIN 0.15

	# Position control velocity
	param set MPC_XY_CRUISE 12.0
	param set MPC_CRUISE_90 3.0
	param set MPC_VEL_MANUAL 12.0
	param set MPC_XY_VEL_MAX 20.0
	param set MPC_Z_VEL_MAX_UP 4.0
	param set MPC_Z_VEL_MAX_DN 3.0
	param set MPC_LAND_SPEED 0.8

	#Position control acceleration
	param set MPC_ACC_HOR_MAX 7.0
	param set MPC_ACC_HOR 3.0
	param set MPC_DEC_HOR_SLOW 1.0
	param set MPC_ACC_DOWN_MAX 3.0
	param set MPC_ACC_UP_MAX 4.0
	param set MPC_JERK_MAX 15
	param set MPC_JERK_MIN 0.1

	# Throttle pid attenuation
	param set MC_TPA_RATE_P 0.0
	param set MC_TPA_RATE_I 0.0
	param set MC_TPA_RATE_D 0.0
	param set MC_TPA_BREAK_P 1.0
	param set MC_TPA_BREAK_I 1.0
	param set MC_TPA_BREAK_D 1.0

	# ekf2
	# these parameters are for first tests
	param set EKF2_AID_MASK 1
	param set EKF2_IMU_POS_X 0.0595
	param set EKF2_IMU_POS_Y 0.014
	param set EKF2_IMU_POS_Z -0.02
	param set EKF2_GPS_POS_X 0.06
	param set EKF2_GPS_POS_Y 0.0
	param set EKF2_GPS_POS_Z -0.02
	param set EKF2_MIN_OBS_DT 50
	param set EKF2_MAG_DELAY 0
	param set EKF2_BARO_DELAY 0
	param set EKF2_GPS_DELAY 100
	param set EKF2_OF_DELAY 5
	param set SYS_MC_EST_GROUP 2
	param set EKF2_BCOEF_X 0.0
	param set EKF2_BCOEF_Y 0.0
	param set EKF2_PCOEF_XP 0.0
	param set EKF2_PCOEF_XN 0.0
	param set EKF2_PCOEF_Y 0.0
	param set EKF2_PCOEF_Z 0.0
	# temp for replay wind and baro compensation tuning
	param set SDLOG_MODE 1

	# Battery settings
	param set BAT_V_EMPTY 3.47
	param set BAT_V_CHARGED 4.3
	param set BAT_CRIT_THR 0.27
	param set BAT_LOW_THR 0.30
	param set BAT_EMERGEN_THR 0.21
	param set BAT_V_LOAD_DROP 0.18

	#RC
	param set COM_RC_LOSS_T 1.5
	param set COM_RC_OVERRIDE 1
	param set COM_RC_LOSS_MAN 1
	param set COM_DISARM_LAND 0.1
	param set COM_ARM_SWISBTN 1

	# Altitude (manual) mode parameters
	param set MPC_MAN_TILT_MAX 30

	# Gyro already temperature calibrated and ID constant
	#param set CAL_GYRO0_ID 3670290


	#
	# Throttle max/min setting
	#
	param set MPC_THR_MAX 0.94
	param set MPC_THR_MIN 0.1

	#
	# RTL settings
	#
	param set MIS_LTRMIN_ALT 5.0
	param set RTL_LAND_DELAY 3.5
	param set LAND_LOI_DELAY 3.5

	#
	# Mission settings
	#
	param set MIS_DIST_WPS 4000

	# Vehicle model settings
	#
	param set LNDMC_ALT_MAX 120.0

	#
	# Maximum tilt angle
	#
	param set MPC_TILTMAX_AIR 35.0

	#
	# Battery setting
	#
	param set BAT_N_CELLS 3

	#
	# Acceptance radius
	#
	param set NAV_ACC_RAD 1.0

	#
	# Calibrate by rotating around axes
	#
	param set CAL_MAG_METHOD 0

	#
	# Flight modes
	#

	#
	# Flight modes
	#
	# Altitude hold
	param set COM_FLTMODE6 1
	# Position
	param set COM_FLTMODE4 2
	# RTL
	param set COM_FLTMODE1 5

	#
	# ST16 RC channel configuration
	#

	# analog channels
	param set RC_CHAN_CNT 14
	param set RC_MAP_THROTTLE 1
	param set RC_MAP_YAW 2
	param set RC_MAP_PITCH 3
	param set RC_MAP_ROLL 4
	# pan control knob
	param set RC_MAP_AUX1 5
	# tilt control slider
	param set RC_MAP_AUX2 6
	# tortoise slider
	param set RC_MAP_AUX5 7

	# switch channels
	# arm button
	param set RC_MAP_ARM_SW 8
	param set COM_ARM_SWISBTN 1
	# gear switch
	param set RC_MAP_GEAR_SW 9
	# mode switch
	param set RC_MAP_FLTMODE 10
	# obstacle avoidance switch
	param set RC_MAP_AVOID_SW 11
	# gimbal pan mode switch
	param set RC_MAP_AUX4 12
	# gimbal tilt mode switch
	param set RC_MAP_AUX3 13
	# kill switch hotkey
	param set RC_MAP_KILL_SW 14

	# channel calibration
	# RC mapping sends 12 bit values [0,4095]
	# Because ST16 factory calibration can lead to offset from maximum and minimum
	# we cut 95 (2.3%) from top and bottom such that we are sure to reach the limits
	set CHANNEL_MAX 4000.0
	set CHANNEL_MIN 95.0
	set CHANNEL_MID 2048.0
	param set RC1_MAX ${CHANNEL_MAX}
	param set RC1_MIN ${CHANNEL_MIN}
	param set RC1_REV 1.0
	param set RC1_TRIM ${CHANNEL_MID}
	param set RC2_MAX ${CHANNEL_MAX}
	param set RC2_MIN ${CHANNEL_MIN}
	param set RC2_REV 1.0
	param set RC2_TRIM ${CHANNEL_MID}
	param set RC3_MAX ${CHANNEL_MAX}
	param set RC3_MIN ${CHANNEL_MIN}
	param set RC3_REV 1.0
	param set RC3_TRIM ${CHANNEL_MID}
	param set RC4_MAX ${CHANNEL_MAX}
	param set RC4_MIN ${CHANNEL_MIN}
	param set RC4_REV 1.0
	param set RC4_TRIM ${CHANNEL_MID}
	param set RC5_MAX ${CHANNEL_MAX}
	param set RC5_MIN ${CHANNEL_MIN}
	param set RC5_TRIM ${CHANNEL_MID}
	param set RC6_MAX ${CHANNEL_MAX}
	param set RC6_MIN ${CHANNEL_MIN}
	param set RC6_TRIM ${CHANNEL_MID}
	param set RC7_MAX ${CHANNEL_MAX}
	param set RC7_MIN ${CHANNEL_MIN}
	param set RC7_TRIM ${CHANNEL_MID}

	# TODO: remove these after every vehicle was updated
	# because these are the default values
	param set RC_AVOID_TH 0.25
	param set RC_AVOID_MID_TH 0.75
	param set RC8_MAX 2000.0
	param set RC8_MIN 1000.0
	param set RC8_TRIM 1500.0
	param set RC9_MAX 2000.0
	param set RC9_MIN 1000.0
	param set RC9_TRIM 1500.0
	param set RC10_MAX 2000.0
	param set RC10_MIN 1000.0
	param set RC10_TRIM 1500.0
	param set RC11_MAX 2000.0
	param set RC11_MIN 1000.0
	param set RC11_REV 1.0
	param set RC11_TRIM 1500.0

	# gimbal driver configuration
	param set MNT_MODE_IN 4
	param set MNT_MODE_OUT 2
	param set MNT_MAN_ROLL 0
	param set MNT_MAN_PITCH 2
	param set MNT_MAN_YAW 1

	# sensor thermal calibration
	param set SYS_CAL_TDEL 60
	param set SYS_CAL_ACC_TOL 1
	param set SYS_CAL_GYRO_TOL 0.1

	# Fault tolerant control
	# 0: disabled
	# 1: enabled
	param set FTC_ENABLE 0

	# Events
	param set EV_TSK_STAT_DIS 1
	param set EV_TSK_RC_LOSS 0

	param save
fi

#
# Flow driver
#
yuneec_flow start -d /dev/ttyS2

#
# If necessary and possible, update ESC firmware before starting the ESC driver
#
#if tap_esc_config update_fw -d ${ESC_TTY} -n 4
#then
#	# Related to issue #1470, the ESCs will not respond to the version query
#	# after an update unless the basic configuration is sent. Hence the config
#	# has been moved here to right after the update.
#	tap_esc_config send_basic_config -d ${ESC_TTY} -n 4
#
#
#	# reboot should theoretically not be required since tap_esc_config runs and
#	# then exits before starting the tap_esc driver. However, currently there are
#	# two problems when omitting the reboot:
#	# 1. When the ESCs are upgraded, tap_esc will be started after the fw has been
#	#    flashed. For some reason the LEDs then blink purple instead of the normal
#	#    pattern.
#	# 2. There is less free memory after an ESC fw upgrade, even though
#	#    tap_esc_config exited. This could indicate a memory leak in the uploader.
#	#
#	echo "ESC firmware updated - rebooting system"
#	reboot
#fi

#
# ESC driver
#
# First re-send ESC configuration and verify to make sure everything is setup
if tap_esc_config send_basic_config -d ${ESC_TTY} -n 4 -v
then
	if [ $HITL_ON == no ]
	then
		tap_esc start -d ${ESC_TTY} -n 4
	else
		tap_esc start -d ${ESC_TTY} -n 4 -l
	fi
else
	# Config could not be written or verified. ESCs won't function properly!
	echo "tap_esc_config send_basic_config failed - not starting the ESC driver"
fi


set OUTPUT_MODE tap_esc

set MIXER quad_x
