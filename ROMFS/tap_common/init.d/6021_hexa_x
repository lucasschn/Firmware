#!nsh
#
# @name Generic Hexarotor x geometry
#
# @type Hexarotor x
# @class Copter
#
# @output AUX1 feed-through of RC AUX1 channel
# @output AUX2 feed-through of RC AUX2 channel
# @output AUX3 feed-through of RC AUX3 channel
#
# @maintainer Matthias Grob <matthias@yuneecresearch.com>
#

sh /etc/init.d/rc.mc_defaults

if [ ${AUTOCNF} == yes -o ${NEW_DEFAULTS} == yes ]
then
	param set MAV_TYPE 13

	#
	# Control parameters setting for TAP
	#

	if ver hwcmp TAP_V1
	then
		# TAP v1
		# pitch angle & rate setting
		param set MC_PITCHRATE_P 0.13
		param set MC_PITCHRATE_I 0.000
		param set MC_PITCHRATE_D 0.0032
		param set MC_PITCHRATE_MAX 360.0
		param set MC_PITCH_P 4.5

		# roll angle & rate setting
		param set MC_ROLLRATE_P 0.13
		param set MC_ROLLRATE_I 0.000
		param set MC_ROLLRATE_D 0.0032
		param set MC_ROLLRATE_MAX 360.0
		param set MC_ROLL_P 4.5

		# yaw angle & rate setting
		param set MC_YAWRATE_P 0.12
		param set MC_YAWRATE_I 0.05
		param set MC_YAWRATE_MAX 120.0
		param set MC_YAW_P 3.0

		# hover thrust
		# not tuned
		param set MPC_THR_HOVER 0.4

		# Battery setting
		param set BAT_V_CHARGED 4.2
	else
		# TAP v2
		# pitch angle & rate setting
		param set MC_PITCHRATE_P 0.09
		param set MC_PITCHRATE_I 0.09
		param set MC_PITCHRATE_D 0.001
		param set MC_PITCHRATE_MAX 360.0
		param set MC_PITCH_P 6

		# roll angle & rate setting
		param set MC_ROLLRATE_P 0.09
		param set MC_ROLLRATE_I 0.09
		param set MC_ROLLRATE_D 0.001
		param set MC_ROLLRATE_MAX 360.0
		param set MC_ROLL_P 6

		# yaw angle & rate setting
		param set MC_YAWRATE_P 0.1495
		param set MC_YAWRATE_I 0.0575
		param set MC_YAWRATE_MAX 100.0
		param set MC_YAWRAUTO_MAX 80.0
		param set MC_YAW_P 3.5

		# hover thrust
		param set MPC_THR_HOVER 0.49

		# Position control parameters
		param set MPC_XY_P 1.3
		param set MPC_XY_VEL_P 0.22
		param set MPC_XY_VEL_D 0.007
		param set MPC_XY_VEL_I 0.09
		param set MPC_Z_VEL_P 0.25
		param set MPC_Z_P 0.85
		param set MPC_Z_VEL_D 0.0
		param set MPC_Z_VEL_I 0.085

		# Manual stick input parameters
		param set RC_FLT_SMP_RATE 33.0
		param set RC_FLT_CUTOFF 5.0
		param set MPC_HOLD_DZ 0.1
		param set MPC_XY_MAN_EXPO 0.7
		param set MPC_Z_MAN_EXPO 0.6
		param set MPC_YAW_EXPO 0.6
		param set MPC_MANTHR_MIN 0.15
		param set MPC_MAN_Y_MAX 100.0

		# Position control velocity
		param set MPC_XY_CRUISE 10.0
		param set MPC_CRUISE_90 3.0
		param set MPC_XY_VEL_MAX 14.0
		param set MPC_Z_VEL_MAX_UP 7.0
		param set MPC_Z_VEL_MAX_DN 6.0
		param set MPC_LAND_SPEED 0.8
		param set MPC_VEL_MANUAL 10.0

		# Position control acceleraton
		param set MPC_ACC_HOR_MAX 10.0
		param set MPC_ACC_HOR 6.0
		param set MPC_DEC_HOR_SLOW 1.0
		param set MPC_ACC_DOWN_MAX 6.0
		param set MPC_ACC_UP_MAX 6.0
		param set MPC_JERK_MAX 15
		param set MPC_JERK_MIN 0.1

		# Throttle pid attenuation
		param set MC_TPA_RATE_P 0.8
		param set MC_TPA_RATE_I 0.5
		param set MC_TPA_RATE_D 0.2
		param set MC_TPA_BREAK_P 0.45
		param set MC_TPA_BREAK_I 0.6
		param set MC_TPA_BREAK_D 0.65

		# Battery settings
		param set BAT_V_EMPTY 3.56
		param set BAT_V_CHARGED 4.15
		param set BAT_R_INTERNAL 0.005
		param set BAT_CAPACITY 6500.0
		param set BAT_LOW_THR 0.15
		param set BAT_CRIT_THR 0.1
		param set BAT_EMERGEN_THR 0.05

		# RC
		param set COM_RC_OVERRIDE 1
		param set COM_RC_LOSS_T 3.0
		param set COM_DL_LOSS_T 10

		# allow receiving team mode input
		param set RC_LINK_MODE 3

		# Altitude (manual) mode parameters
		param set MPC_MAN_TILT_MAX 24

		# Gyro already temperature calibrated and ID constant
		if ver hwcmp TAP_V2
		then
			param set CAL_GYRO0_ID 3670290
		fi

		param set COM_DISARM_LAND 0.1
	fi

	#
	# Throttle max/min setting
	#
	param set MPC_THR_MAX 0.9
	param set MPC_THR_MIN 0.1

	#
	# RTL settings
	#
	param set MIS_LTRMIN_ALT 5.0
	param set RTL_LAND_DELAY 3.5
	param set LAND_LOI_DELAY 3.5

	#
	# Mission settings
	#
	param set MIS_YAW_ERR 90.0
	param set MIS_DIST_WPS 4000

	#
	# Vehicle model settings
	#
	param set LNDMC_ALT_MAX 500.0

	#
	# Maximum tilt angle
	#
	param set MPC_TILTMAX_AIR 35.0

	#
	# Battery setting
	#
	param set BAT_N_CELLS 4

	#
	# Acceptance radius
	#
	param set NAV_ACC_RAD 1.0

	#
	# Calibrate by rotating around arms
	#
	param set CAL_MAG_METHOD 1

	#
	# Flight modes
	#
	# Altitude hold
	param set COM_FLTMODE1 1
	# Position
	param set COM_FLTMODE2 2
	# RTL
	param set COM_FLTMODE3 5

	#
	# ST16 RC channel configuration
	#

	# remote control station type set to ST16
	param set RC_TYPE 1

	# gimbal driver configuration
	param set MNT_MODE_IN 4
	param set MNT_MODE_OUT 2
	param set MNT_MAN_ROLL 0
	param set MNT_MAN_PITCH 2
	param set MNT_MAN_YAW 1

	# sensor thermal calibration
	param set SYS_CAL_TDEL 60
	param set SYS_CAL_ACC_TOL 1
	param set SYS_CAL_GYRO_TOL 0.1

	# Enable power circuit breaker
	# HOTFIX: This disables the preflight checks for 5v and 3.3v power rails
	# which are not available on TAP_V2. Should find a better solution.
	param set CBRK_SUPPLY_CHK 894281

	# Fault tolerant control
	# 0: disabled
	# 1: enabled
	param set FTC_ENABLE 1

	# Events
	param set EV_TSK_STAT_DIS 1
	param set EV_TSK_RC_LOSS 0
	param set EV_TSK_INV_GEAR 1

	param save
fi

#
# If necessary and possible, update ESC firmware before starting the ESC driver
#
if tap_esc_config update_fw -d ${ESC_TTY} -n 6
then
	# Related to issue #1470, the ESCs will not respond to the version query
	# after an update unless the basic configuration is sent. Hence the config
	# has been moved here to right after the update.
	tap_esc_config send_basic_config -d ${ESC_TTY} -n 6


	# reboot should theoretically not be required since tap_esc_config runs and
	# then exits before starting the tap_esc driver. However, currently there are
	# two problems when omitting the reboot:
	# 1. When the ESCs are upgraded, tap_esc will be started after the fw has been
	#    flashed. For some reason the LEDs then blink purple instead of the normal
	#    pattern.
	# 2. There is less free memory after an ESC fw upgrade, even though
	#    tap_esc_config exited. This could indicate a memory leak in the uploader.
	#
	echo "ESC firmware updated - rebooting system"
	reboot
fi

#
# Log ESC Firmware, Bootloader and Hardware version
# NOTE: This should obviously always be executed AFTER an ESC firmware upgrade!
#
tap_esc_config log_versions -d ${ESC_TTY} -n 6

#
# ESC driver
#
# First re-send ESC configuration and verify to make sure everything is setup
if tap_esc_config send_basic_config -d ${ESC_TTY} -n 6 -v
then
	if [ ${HITL_ON} == no ]
	then
		tap_esc start -d ${ESC_TTY} -n 6
	else
		tap_esc start -d ${ESC_TTY} -n 6 -l
	fi
else
	# Config could not be written or verified. ESCs won't function properly!
	echo "tap_esc_config send_basic_config failed - not starting the ESC driver"
fi


set OUTPUT_MODE tap_esc

set MIXER hexa_x
